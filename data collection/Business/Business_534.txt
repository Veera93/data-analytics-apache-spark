 WASHINGTON — The Senate gave final approval on Wednesday to legislation that strengthens the policing of sex trafficking, over the opposition of many internet companies. Lawmakers are trying to catch up to the reality of prostitution long after the bartering of children and adults moved from the streets to the web. The 97-to-2 vote was the culmination of a multiyear effort by Republicans and Democrats to allow state law enforcement officials to go after websites like Backpage.com that facilitate sex trafficking. The bill would also suspend protections that shielded internet companies from legal liability for the content on their sites. The legislation has pitted lawmakers against Silicon Valley companies and civil liberties groups, which hold starkly differing views on the government’s oversight of the internet. Big tech companies like Facebook and Google have flourished with little regulation for years, but they have come under intense scrutiny after their platforms were manipulated by foreign agents during the 2016 presidential election. With passage of the  Fight Online Sex Trafficking Act, Silicon Valley’s ability to stay out of the government’s reach suffered a rare setback. The bill passed the House overwhelmingly last month, and President Trump is expected to sign it into law. “The president and his entire administration are firmly committed to holding those who participate in these horrific crimes accountable, and look forward to continued work with these stakeholders in order to put an end to this scourge,” the White House press secretary, Sarah Huckabee Sanders, said in a statement after the vote. “It’s a wake-up call,” said Senator John Thune of South Dakota, chairman of the Senate Commerce Committee, which convened hearings on sex trafficking. “This is clearly illegal activity. It was happening online. But I think in the future, tech companies have to understand that it’s not the wild West, and they have to exercise responsibility.” Paul Gallant, an analyst at Cowen, said the sex trafficking bill would not directly hurt big internet companies. But he said it was “cracking the door open to broader platform liability for other types of content.” “Today, it’s sex trafficking,” he added. “And down the road, it’s content from foreign governments.” Internet companies have feared the bill would weaken a crucial legal shield that since 1996 has guarded them from liability for illegal content on their sites. They point to the safe harbor provision as the foundation for the growth of internet commerce. Civil liberties groups have decried the bill as a threat to free speech and a limit to the free flow of content on the web. But that protection for websites, lawmakers argued, has been abused and needed revision so law enforcement could pursue the worst perpetrators, such as Backpage.com, a popular classified advertising site that freely advertises sex for sale, while hiding behind the safe harbor clause. The new bill will allow state police and attorneys general to go after sites that knowingly host sex trafficking content. It will also allow victims of sex trafficking to sue such sites for damages. “This is legislation that is overdue in my view, and it’s required,” said Senator Rob Portman, Republican of Ohio, who was a co-author of the bill with Senator Richard Blumenthal, Democrat of Connecticut. “The courts have told us that. The district attorneys have told us that. The attorneys general told us that.” When it was introduced in August 2017, the bill attracted immediate support from law enforcement and advocates for victims of sex trafficking. It also drew intense opposition from tech companies and free-speech advocates, who say any weakening of liability protections would lead to abuse by law enforcement, hurt start-ups that cannot afford to fight lawsuits and stifle free speech. The law “would almost certainly cause irreparable harm to free speech and the internet economy,” said Robyn Greene, policy counsel and government affairs chief for Open Technology Institute at New America, a research and advocacy group. But with prominent fights flaring over Russian election interference, data breaches and other scandals, the biggest tech companies — no longer wishing to publicly oppose a bill fighting sex trafficking — retreated from their lobbying effort in recent weeks. The Internet Association, a trade group whose members include Facebook, Google, Netflix and Apple, has backed off from the strong stance they had against the bill when it was introduced. “The internet industry shares the goals of lawmakers who want to put an end to trafficking online, and Internet Association will continue to be a key partner with policymakers on this important issue,” said Michael Beckerman, president of the group, who added that it would work to preserve other aspects of the liability shield. The legislation stemmed from a two-year Senate investigation led by Mr. Portman into Backpage.com, the classifieds page rampant with ads for prostitution and sex trafficking. During the investigation, Mr. Portman and Mr. Blumenthal heard from state law enforcement officials who said that they were not able to press charges against websites like Backpage.com, which evoked safe harbor under the liability portion of the 1996 Communications Decency Act. “We’re opening the courthouse doors,” Mr. Blumenthal said after Wednesday’s vote. According to the National Center for Missing and Exploited Children, nearly 90 percent of the trafficking of children occurs online. Seven out of 10 child trafficking reports involve Backpage.com, the group said. But over the past seven years, 20 cases involving the website were rejected by courts that “acknowledged the horror of the allegations made regarding the child victims’ trafficking” but were “powerless to act,” Yiota G. Souras, general counsel for the National Center for Missing and Exploited Children, told Congress last November. The liability provision, created by Senator Ron Wyden, Democrat of Oregon, was intended to help foster the growth of the nascent internet. It was adopted before smartphones and companies like Google and Facebook existed. On Wednesday, Mr. Wyden argued on the Senate floor that the bill as written would harm the internet economy. “It’ll pull up the ladder, leaving the established giants at the top,” Mr. Wyden said. Start-ups need the legal shield most, not tech giants, he added: “The big guys can take care of themselves.” Mr. Wyden was one of two senators to oppose the bill; the other was Senator Rand Paul, Republican of Kentucky. Dozens of victims’ advocates hailed the bill as landmark action to fight trafficking. “This is a huge day for victims because we are finally saying enough is enough,” said Lauren Hersh, the national director for World Without Exploitation, a group for victims’ rights. “They will no longer allow companies to profit from ads that make millions off the backs of exploited people.”